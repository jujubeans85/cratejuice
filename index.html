
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CrateJuice — One‑Shot Ripper</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    body{background:#0b0b0c;color:#eee;font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;margin:0;padding:2rem;}
    h1{margin:0 0 1rem 0}
    .card{background:#141416;border:1px solid #2a2a2d;border-radius:12px;padding:1rem;max-width:800px}
    input,button{font-size:1rem}
    input[type=url]{width:100%;padding:.7rem;border-radius:8px;border:1px solid #333;background:#1b1c1f;color:#eee}
    .row{display:flex;gap:.5rem;margin-top:.75rem}
    button{padding:.7rem 1rem;border:1px solid #444;background:#ff6a00;color:#111;border-radius:8px;font-weight:700;cursor:pointer}
    button.secondary{background:#1b1c1f;color:#ddd}
    .list{margin-top:1rem}
    audio{width:100%;margin-top:.5rem}
    .hint{opacity:.7;font-size:.9rem}
    .ok{color:#8df58d} .bad{color:#ff7777}
  </style>
</head>
<body>
  <h1>CrateJuice — One‑Shot Ripper</h1>
  <div class="card">
    <div class="hint">Backend: <span id="burl"></span> · Health: <span id="health"></span></div>
    <div class="row">
      <input id="url" type="url" placeholder="Paste YouTube / SoundCloud URL…" />
      <button id="rip">Rip</button>
      <button class="secondary" id="recent">Refresh</button>
    </div>
    <div id="out"></div>
    <div class="list" id="list"></div>
  </div>
<script>
const qs = new URLSearchParams(location.search);
const backend = qs.get('api') || localStorage.getItem('cj_api') || 'https://RENDER-URL.onrender.com';
document.getElementById('burl').textContent = backend;
localStorage.setItem('cj_api', backend);

async function getHealth(){
  try{
    const r = await fetch(backend+'/health');
    const j = await r.json();
    document.getElementById('health').textContent = j.ok ? 'OK' + (j.ffmpeg ? ' (ffmpeg)' : ' (no ffmpeg)') : 'down';
    document.getElementById('health').className = j.ok ? 'ok' : 'bad';
  }catch(e){ document.getElementById('health').textContent = 'down'; document.getElementById('health').className = 'bad'; }
}
getHealth();

async function ripOne(){
  const url = document.getElementById('url').value.trim();
  if(!url) return;
  document.getElementById('out').textContent = 'Ripping…';
  const r = await fetch(backend+'/rip', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({url})
  });
  const j = await r.json();
  if(j.ok){
    document.getElementById('out').innerHTML = 'Done: <a href="'+backend+j.url+'">'+j.file+'</a>';
    await listRecent();
  } else {
    document.getElementById('out').textContent = 'Failed: ' + JSON.stringify(j);
  }
}
document.getElementById('rip').onclick = ripOne;
document.getElementById('recent').onclick = () => listRecent();

async function listRecent(){
  const r = await fetch(backend+'/recent');
  const j = await r.json();
  const box = document.getElementById('list');
  box.innerHTML = '';
  (j.items||[]).forEach(it=>{
    const a = document.createElement('div');
    a.innerHTML = '<a href="'+backend+it.url+'">'+it.file+'</a> · '+Math.round(it.size/1024)+' KB'+
      '<audio controls src="'+backend+it.url+'"></audio>';
    box.appendChild(a);
  });
}
listRecent();
</script>
</body>
</html>
